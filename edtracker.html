<style>
	html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{border:0;font-size:100%;font:inherit;vertical-align:baseline;margin:0;padding:0}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:none}table{border-collapse:collapse;border-spacing:0}
		
	
	#edtracker-container {
		width:350px;
		height:auto;
		margin:0 auto;
	}
		
		.tracker-link {
			text-decoration:none;
		}
		
		.tracker-link:hover {
			text-decoration:none;
		}
	
		.tracked-bill {
			border:2px solid #4c5b52;
			width:350px;
			margin:10px 0;
			cursor:pointer;
		}
		
	
		
			.tracker-row {
				height:auto;
				background:#F8F7F1;
				padding:5px 0 0 0;
			}
			
			.tracker-row:hover {
				background:#E0DFDA;
			}
			
				.tracker-row h2, #edtracker-header h2 {
					font:300 24px "helvetica neue";
					margin:0 10px;
					color:#4c5b52;
				}
				
				.tracker-row p, #edtracker-header p {
					font:400 14px "helvetica neue";
					margin:5px 10px;
					width:330px;
					color:#8c9b93;
				}
				
				.tracker-info {
					border-bottom:1px solid #8c9b93;
					padding:0 0 10px 0;
				}				
					
			
				.tracker-detail {
					height:70px;
					background:#4c5b52;
				}
										
					.tracker-step {
						width:50px;
						height:50px;
						margin:10px 18.7px;
						float:left;
					}
			
		
					
		#tracker-footer {
			height:30px;
			background:#4c5b52;
		}
		
	#edtracker-header {
		width:350px;
		margin:0 auto;
		border:2px solid #4c5b52;
		background:#F8F7F1;
		
	}
		#edtracker-header h2 {
			text-align:center;
			font-weight:700 !important;
		}
		
		#edtracker-header p {
			color:#4c5b52;
		}
</style>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://www.edsource.org/wp-content/js/caltip.min.js"></script>
<script src="http://www.edsource.org/wp-content/js/tabletop.js"></script>

<script>
	//GLOBAL VARS
	var public_spreadsheet_url = "https://docs.google.com/spreadsheets/d/1cD2JFoFjb75BO92HKVdr5q4lF2ZcefBh5E4H4xQQIVk/pubhtml"; //GSHEET -- CHANGE ME!
	var billDB = [], billDetails = [], billsCleaned = [];
	
	//TABLETOP
	$(document).ready(function(){
			Tabletop.init( { key: public_spreadsheet_url,
		                     callback: showInfo,
		                     wanted: ["Bills"],
		                     debug: true } );
	});

	function showInfo(data, tabletop) {		
		$.each( tabletop.sheets("Bills").all(), function(i, bills) {
			var insertRow = [];
			insertRow[0] = bills.title;
			insertRow[1] = bills.api;
			billDB.push(insertRow);
		});
		
		//GET DATA
		for (i=0 ; i<billDB.length;i++){
			(function(i){ //this is needed because the loop executes before jSON returns value
				$.getJSON(billDB[i][1], function (data) {billDetails[i] = data;});
		   	})(i);
		}	
	}
	
	//EXECUTES TRACKER -- important to load a few seconds after API loads
	setTimeout(function() { executeTracker() },2000);
	
	//PRIME FUNCTION
	function executeTracker(){
		grabVitals();
		populateVitals(); 
		return console.log("Tracker Populated. No Errors.");
	}

	//MAJOR FUNCTIONS
	function grabVitals(){	
		//latest type of action
		for (i=0 ; i < billDetails.length ; i++){
			var latestAction = billDetails[i].actions.length - 1; //stores latest action number from array
			var splitDate, grabVeto;
			var stashArray = [];
			billsCleaned[i] = new Object();
			//grab bill general details -----------------------------------------------//
				billsCleaned[i].bill_number = billDetails[i].bill_id;
				billsCleaned[i].url = billDetails[i].sources[0].url;
				splitDate = billDetails[i].action_dates.first.split(" ");
				billsCleaned[i].first_action = splitDate[0];
				billsCleaned[i].chamber_origin = billDetails[i].chamber;
				billsCleaned[i].summary = billDetails[i].summary;
				billsCleaned[i].title = billDB[i][0];
				splitDate = billDetails[i].updated_at.split(" ");
				billsCleaned[i].updated = splitDate[0];				
				//find intro -----------------------------------------------//
				if 	(typeof billDetails[i].actions[0].action !== 'undefined' && billDetails[i].actions[0].action !== null){
					billsCleaned[i].intro = "Yes"
				}				
				//find lower chamber-----------------------------------------------//
				for (ii=0 ; ii < billDetails[i].actions.length ; ii++){
					var expression = billDetails[i].actions[ii].action;
					var testPass = /passed/i;
					var testFail = /refused passage/i;
					var resultPass = expression.match(testPass);
					var resultFail = expression.match(testFail);
					if (resultPass !== null && billDetails[i].actions[ii].actor === "lower"){
						billsCleaned[i].passed_lower = true;
					}
					else if (resultFail !== null && billDetails[i].actions[ii].actor === "lower"){
						billsCleaned[i].passed_lower = "Killed";
					}
				}				
				//find upper chamber-----------------------------------------------//
				for (ii=0 ; ii < billDetails[i].actions.length ; ii++){
					var expression = billDetails[i].actions[ii].action;
					var testPass = /passed/i;
					var testFail = /refused passage/i;
					var resultPass = expression.match(testPass);
					var resultFail = expression.match(testFail);
					if (resultPass !== null && billDetails[i].actions[ii].actor === "upper"){
						billsCleaned[i].passed_upper = true;
					}
					else if (resultFail !== null && billDetails[i].actions[ii].actor === "upper"){
						billsCleaned[i].passed_upper = "Killed";
					}
				}				
				//find enroll-----------------------------------------------//
				for (ii=0 ; ii < billDetails[i].actions.length ; ii++){
					var expression = billDetails[i].actions[ii].action;
					var test = /Enrolled/i;
					var result = expression.match(test);
					if (result !== null){
						billsCleaned[i].enrolled = true;
					}
				}				
				//find gov signed------------------------------------------//
				for (ii=0 ; ii < billDetails[i].actions.length ; ii++){
					var expression = billDetails[i].actions[ii].action;
					var test = /Approved by the Governor/i;
					var result = expression.match(test);
					if (result !== null){
						billsCleaned[i].signed = true;
					}
				}				
				//find veto -----------------------------------------------//
				for (ii=0 ; ii < billDetails[i].actions.length ; ii++){
					var expression = billDetails[i].actions[ii].action;
					var test = /vetoed by gov/i;
					var result = expression.match(test);
					if (result !== null){
						billsCleaned[i].veto = true;
					}
				}			
				
			//---------------------------------------------------------------------//
			
			//find latest action -----------------------------------------------//
				billsCleaned[i].latest_action_type = billDetails[i].actions[latestAction].type[0];
				billsCleaned[i].latest_action = billDetails[i].actions[latestAction].action;
				billsCleaned[i].latest_action_actor = billDetails[i].actions[latestAction].actor;
				splitDate = billDetails[i].actions[latestAction].date.split(" ");
				billsCleaned[i].lastest_action_date = splitDate[0];
			//---------------------------------------------------------------------//
			
		}
	}

	
	function populateVitals(){
		
		//build the actual graphic -----------------------------------------------//
			for (i=0; i < billsCleaned.length; i++){
				$("#edtracker-container").append("<a onmouseover=\"_gaq.push(['_trackEvent', 'EDTRACKER', 'Interaction', 'Hover Over']);\" onclick=\"_gaq.push(['_trackEvent', 'EDTRACKER', 'Click', 'Bill']);\" target=\"_blank\" class=\"tracker-link\" href=\"" + billsCleaned[i].url + "\"><div id=\"tracked-bill-" + i + "\" class=\"tracked-bill\"><div data=\"" + i + "\" class=\"tracker-row\" data-state=\"false\"><div data=\"" + i + "\" class=\"tracker-info\"><h2>" + billsCleaned[i].bill_number + ":</h2><p>" + billsCleaned[i].title + "</p></div><div data=\"" + i + "\" class=\"tracker-detail\"><div data=\"0\" class=\"tracker-step\"></div><div data=\"1\" class=\"tracker-step\"></div><div data=\"2\" class=\"tracker-step\"></div><div data=\"3\" class=\"tracker-step\"></div></div></div></a>");
			}
			
		//populate bill states-----------------------------------------------//
			for (i=0; i < billsCleaned.length; i++){
				var origin = billsCleaned[i].chamber_origin;
				
				//BILL INITALIZE
				if (billsCleaned[i].intro === "Yes"){
					$("#tracked-bill-" + i + " .tracker-step:eq(0)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/bill.png\">").caltip({title:"Bill Introduced"});
				}
				
				//CHAMBER ONE CHECKS AND BALANCES
				if (origin === "lower"){
					//STEP ONE INTRO
					$("#tracked-bill-" + i + " .tracker-step:eq(1)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/assembly.png\">").caltip({title:"In Assembly"});
					
					//DID IT PASS?
					if (billsCleaned[i].passed_lower === true){
						$("#tracked-bill-" + i + " .tracker-step:eq(1)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(1)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/assembly-pass.png\">").data("caltip").changeTitle("Assembly Passed");
					}
					else if (billsCleaned[i].passed_lower === "Killed"){
						$("#tracked-bill-" + i + " .tracker-step:eq(1)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(1)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/assembly-fail.png\">").data("caltip").changeTitle("Assembly Killed");
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/dead.png\">").data("caltip").changeTitle("Bill is Dead");
					}
				}
				else {
					//STEP ONE INTRO
					$("#tracked-bill-" + i + " .tracker-step:eq(1)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/senate.png\">").caltip({title:"In Senate"});
					
					//DID IT PASS?
					if (billsCleaned[i].passed_upper === true){
						$("#tracked-bill-" + i + " .tracker-step:eq(1)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(1)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/senate-pass.png\">").data("caltip").changeTitle("Senate Passed");
					}
					else if (billsCleaned[i].passed_upper === "Killed"){
						$("#tracked-bill-" + i + " .tracker-step:eq(1)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(1)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/senate-fail.png\">").data("caltip").changeTitle("Senate Killed");
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/dead.png\">").data("caltip").changeTitle("Bill is Dead");
					}
				}
				
				
				//CHAMBER TWO CHECKS AND BALANCES
				if (origin === "lower" && billsCleaned[i].passed_lower === true){
					//STEP ONE INTRO
					$("#tracked-bill-" + i + " .tracker-step:eq(2)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/senate.png\">").caltip({title:"In Senate"});
					
					//DID IT PASS?
					if (billsCleaned[i].passed_upper === true){
						$("#tracked-bill-" + i + " .tracker-step:eq(2)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(2)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/senate-pass.png\">").data("caltip").changeTitle("Senate Passed");
					}
					else if (billsCleaned[i].passed_upper === "Killed"){
						$("#tracked-bill-" + i + " .tracker-step:eq(2)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(2)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/senate-fail.png\">").data("caltip").changeTitle("Senate Killed");
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/dead.png\">").data("caltip").changeTitle("Bill is Dead");
					}
				}
				else if (billsCleaned[i].passed_upper === true){
					//STEP ONE INTRO
					$("#tracked-bill-" + i + " .tracker-step:eq(2)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/assembly.png\">").caltip({title:"In Assembly"});
					
					//DID IT PASS?
					if (billsCleaned[i].passed_lower === true){
						$("#tracked-bill-" + i + " .tracker-step:eq(2)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(2)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/assembly-pass.png\">").data("caltip").changeTitle("Assembly Passed");
					}
					else if (billsCleaned[i].passed_lower === "Killed"){
						$("#tracked-bill-" + i + " .tracker-step:eq(2)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(2)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/assembly-fail.png\">").data("caltip").changeTitle("Assembly Killed");
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/dead.png\">").data("caltip").changeTitle("Bill is Dead");
					}
				}
				
				//GOVERNOR
				if (billsCleaned[i].passed_lower === true && billsCleaned[i].passed_upper === true){
					//ENROLLED?
					if (billsCleaned[i].enrolled === true){
						$("#tracked-bill-" + i + " .tracker-step:eq(3)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(3)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/enroll.png\">").caltip({title:"Awaiting Governor's Decision"});
					}
					
					if (billsCleaned[i].signed === true){
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(3)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/signed.png\">").data("caltip").changeTitle("Bill is Law");
						$("#tracked-bill-" + i + " .tracker-step:eq(3)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/gov-signed.png\">").data("caltip").changeTitle("Governor Signed");
					}
					
					//VETOED?
					if (billsCleaned[i].veto === true){
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(3)").empty();
						$("#tracked-bill-" + i + " .tracker-step:eq(0)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/dead.png\">").data("caltip").changeTitle("Bill is Dead");
						$("#tracked-bill-" + i + " .tracker-step:eq(3)").append("<img src=\"http://edsource.org/wp-content/iframe/edtracker/assets/veto.png\">").data("caltip").changeTitle("Governor Vetoed");
					}
				}			
			}
	
	}

</script>

<div id="edtracker-header">
	<h2>EdSource EdTracker</h2>
	<p style="font-weight:300px;">Bill status automatically updated daily. Scroll over icon to read the status of a bill. Click on a bill in order to be directed to the official bill page.</p>
	<p><strong>Graphic by John C. Osborn</strong></p>
</div>	
<div id="edtracker-container">
	
</div>

<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-3051201-4']);
	_gaq.push(['_trackPageview']);
	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>

